<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="WebappuserMapper">
<!--  select u.phone, u.id ,u.type   -->
	<resultMap type="resident" id="residentMap">
		<id column="id" property="user_id"/>
		<result column="phone" property="phone"/>
		<result column="lon" property="lon"/>
			<result column="lat" property="lat"/>
	</resultMap>


	<!-- 新增app用户 -->
	<insert id="saveU" parameterType="SignUp">
		insert into webapp_user (
		PASSWORD,
		PHONE
		) values (
		#{password},
		#{phone}
		)
	</insert>

	<!-- 新增thought -->

	<insert id="saveThought" parameterType="thought" useGeneratedKeys="true"
    keyProperty="id">
		insert into
		webapp_thought (
		userid,
		thought,
		moment,
		topic,
		sellingreason
		) values (
		#{userid},
		#{keyInfo},
		#{moment},
		#{topic},
		#{selling_reason}
		)
	</insert>




	<!-- check if the user in database -->
	<select id="checkUser" parameterType="String" resultType="java.lang.Integer">
		select
		id
		from webapp_user
		where
		phone = #{phone}
	</select>



	<!-- login with thought-->
	<select id="login" parameterType="Login" resultType="LoginRes">
		select u.phone, u.id ,u.type ,t.id from webapp_user u left JOIN
		webapp_thought t on(u.id=t.userid)
		where
		u.phone = #{phone} and
		u.PASSWORD = #{password} limit 0,1
	</select>
	
	
	
	
	


	<select id="loginByToken" parameterType="Login" resultType="LoginRes">
		select u.status ,u.phone, u.id ,u.type ,t.thought from webapp_user u
		left JOIN webapp_thought t on(u.id=t.userid)
		where
		u.phone = #{phone}
	</select>



	<select id="searchResident" parameterType="locatRan" resultMap="residentMap">
 select u.phone, u.id ,u.type ,u.lon, u.lat from webapp_user u
		where
		u.lat between #{minLat} and #{maxLat} 
		and
	    u.lon between #{minLng} and #{maxLng} 
	</select>




	<!-- 存入location -->
	<update id="saveLocation" parameterType="Login">
		update webapp_user
		set
		lon = #{current_lng},
		lat= #{current_lat},
		status=1
		where
		phone= #{phone}

	</update>



	<!-- update status -->
	<update id="logout" parameterType="String">
		update webapp_user
		set
		status=0
		where
		phone= #{phone}

	</update>





</mapper>